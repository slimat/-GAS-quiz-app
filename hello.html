<!DOCTYPE html>
<html>
<head>
	<base target="_top">
	<script src="https://code.jquery.com/jquery-3.1.1.js"></script>
</head>
<body>
	<p id="qNum">おはよう</p>
	<p id='qSentence'>こんにちは</p> <!-- 問題文を取得 -->
	<ol>
		<li id='q1'></li> <!-- 選択肢1を表示 -->
		<li id='q2'></li>
		<li id='q3'></li>
		<li id='q4'></li>
	</ol>
	
	<input type="button" id="Button1" value="1" onclick="checkTheAnswer(1)">
	<input type="button" id="Button2" value="2" onclick="checkTheAnswer(2)">
	<input type="button" id="Button3" value="3" onclick="checkTheAnswer(3)">
	<input type="button" id="Button4" value="4" onclick="checkTheAnswer(4)">
	
	<p id='CorrectOrMiss'>ここに正解･不正解が表示されます</p> <!-- 正解･不正解を表示 -->
	<input type="button" id="next" value="次に進む">
	
	<script>
	var countObj = {
		count: 0,
		qNumBefore: 0,
		countPlus: function() {++this.count;},
        four: 0,
	};
    
    /////////////////////////////////////////// 次の問題文と選択肢の取得及び表示 と 回答ボタンの表示及び有効化 ///////////////////////////////////////////
    
	async function nextQuestion(){
        countObj.countPlus(); // 問題番号をインクリメント
		$("#CorrectOrMiss").text('');// 前回の正解･不正解を非表示にする
        if (countObj.count !== 1){ // 一度次に進むボタンが有効化されていたら無効にする
            $("#next")[0].removeEventListener("click",nextQuestion); // 次に進むボタンの無効化
        }
        $("#next").css("opacity", 0.3); // 次に進むボタンの透明度を上げる
		try { // 問題文･選択肢の取得及び表示処理時に
			await callQAInfo(); // 問題文及び選択肢の取得及び表示が終了するまで実行が停止
		} catch (e) {
			$("#Button4").after('<p>error → hello.html → 問題文など取得時 → ' + e.message + '</p>'); // エラー時に画面出力
		}
		
		for (let x = 1; x <= 4; ++x){
			$("#Button" + x).css("opacity", 1); // 回答ボタンの表示
			try { // 回答ボタンの有効化時に発生しうるエラーに対するハンドラの追加
				$("#Button" + x)[0].setAttribute("onclick","checkTheAnswer(" + x + ")"); // 回答ボタンの有効化
			} catch(e) { // もしエラーが発生した場合は
				$("#Button4").after('<p>error → hello.html → 回答ボタン有効化時 → ' + e.message + '</p>'); // エラー時に画面出力
			}
		}
	}
    
	/////////////////////////////////////////// 回答ボタンがクリックされたときに, 正解・不正解を表示 ///////////////////////////////////////////
    
	var checkTheAnswer = async function (clickedNum){
		for (let l = 1; l <= 4; ++l){  // 回答ボタンの無効化
			$("#Button" + l).css("opacity", 0.3); // 回答ボタンの透明度を高める
			$("#Button" + l)[0].setAttribute("onclick", "checkTheAnswer(" + l + ")"); // 回答ボタンの無効化
		}
		await google.script.run.withSuccessHandler(dispCorrectOrMiss).withFailureHandler(failedAccess).withUserObject({qNum: countObj.count, calledFunctionInGS: 'answerButtonClick'}).answerButtonClick(clickedNum, countObj.count);
        try {  // nextボタンを有効化
            $("#next")[0].addEventListener("click", nextQuestion, {once: true});
        } catch(e) {
            $("#Button4").after("<p>error → hello.html → イベントハンドラの追加時 → " + e.message + "</p>"); // ページに表示
        }        
	}
	
    /////////////////////////////////////////// 次の問題文･選択肢を取得及び表示 ///////////////////////////////////////////
    
	function callQAInfo(){
		return new Promise((resolve, reject) => { // Promiseのインスタンスを返す
			google.script.run.withSuccessHandler(setQuestion).withFailureHandler(failedAccess).withUserObject({qNum: countObj.count, calledFunctionInGS: "QAInfo", resolveA: resolve, rejectA: reject}).QAInfo(countObj.count); // countObj.count番目の問題を出題
		});
	}    
    
    /////////////////////////////////////////// 問題文と選択肢を表示 ///////////////////////////////////////////
    
	function setQuestion(data, d){
		$("#qNum").text('問題' + d.qNum); // 問題番号を表示
		$("#qSentence").text(data[0][0]); // 問題文を表示
		for (let j=1; j<=4; ++j){
			$("#q" + j).text(data[0][j]); // 選択肢を表示
        }
		d.resolveA(); // Promiseのインスタンス値をfulfilledにする
	}
	
    /////////////////////////////////////////// 正解･不正解を表示 ///////////////////////////////////////////
    
	function dispCorrectOrMiss(OrMiss){
		if (OrMiss == 1){
			$("#CorrectOrMiss").text('正解');
		} else {
			$("#CorrectOrMiss").text('不正解');
		}
		$("#next").css("opacity", 1); // 次に進むボタンを表示
	}
	
    /////////////////////////////////////////// gs関数の呼び出しに失敗したら ///////////////////////////////////////////
    
	function failedAccess(err, obj){
		$("#Button4").after('<p>missed to call ' + obj.calledFunctionInGS + ' error : ' + err + '</p>'); // ページに表示
	}
	
	nextQuestion();
	</script>
</body>
</html>