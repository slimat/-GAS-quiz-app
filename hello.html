<!DOCTYPE html>
<html>
<head>
	<base target="_top">
	<script src="https://code.jquery.com/jquery-3.1.1.js"></script>
</head>
<body>
	<p id="qNum">おはよう</p>
	<p id='qSentence'>こんにちは</p> <!-- 問題文を取得 -->
	<ol>
		<li id='q1'></li> <!-- 選択肢1を表示 -->
		<li id='q2'></li>
		<li id='q3'></li>
		<li id='q4'></li>
	</ol>
	
	<input type="button" id="Button1" value="1">
	<input type="button" id="Button2" value="2">
	<input type="button" id="Button3" value="3">
	<input type="button" id="Button4" value="4">
	
	<p id='CorrectOrMiss'></p> <!-- 正解･不正解を表示 -->
	<input type="button" id="next" value="次に進む">
	
	<script>
	var countObj = {
		count: 0,
		qNumBefore: 0,
		countPlus: function() {++this.count;},
		four: 0
	};
	
	var checkTheAnswer = async function (clickedNum){ // 回答ボタンがクリックされたときに, 正解・不正解を表示
		for (var l = 1; l <= 4; ++l){  // 回答ボタンの無効化
			document.getElementById("Button" + l).style.opacity = 0.3;
			document.getElementById("Button" + l).onclick = "";
		}
		await google.script.run.withSuccessHandler(dispCorrectOrMiss).withFailureHandler(failedAccess).withUserObject(countObj.count, 'answerButtonClick').answerButtonClick(clickedNum, countObj.count);
	}
	
	function callQAInfo(){
		return new Promise((resolve, reject) => {
			//          const a = resolve;
			//          google.script.run.withSuccessHandler(setQuestion).withFailureHandler(failedAccess).withUserObject(countObj.count, 'QAInfo', a).QAInfo(countObj.count);
			google.script.run.withSuccessHandler(setQuestion).withFailureHandler(failedAccess).withUserObject({countObjCount: countObj.count, QAInfo: 'QAInfo', resolveA: resolve}).QAInfo(countObj.count);
		});
	}
	
	async function nextQuestion() { // 次の問題文を取得
		$("#CorrectOrMiss").html('');// 前回の正解･不正解を非表示にする
		$("#next").style.opacity = 0; // 次に進むボタンを見えなくする
		$("#next").onclick = ""; // 次に進むボタンの無効化
		countObj.countPlus();
		//        document.getElementById("Button4").insertAdjacentHTML('afterend','<p>countObj.four(forの前) = ' + countObj.four + '</p>'); // ページに表示
		try { // 問題文の取得
			await callQAInfo(); // 問題文の取得が終了するまで回答ボタンが表示されない
			//            document.getElementById("Button4").insertAdjacentHTML('afterend', '<p>問題文の表示完了!</p>');
		} catch (e) {
			document.getElementById("Button4").insertAdjacentHTML('afterend','<p>error → hello.html → 問題文など取得時 → ' + e.message + '</p>'); // エラー時ページに表示
		}
		
		for (let x = 1; x <= 4; ++x){
			document.getElementById("Button" + x).style.opacity = 1;
			try { // 回答ボタンの有効化
				document.getElementById("Button" + x).addEventListener("click", {tmp: (() => {countObj.four = x;})(), handleEvent: function (event){checkTheAnswer(x);}}); // 回答ボタンの有効化
				//                document.addEventListener("click", {tmp: (() => {countObj.four = x;})(), handleEvent: handleEvent}); // 回答ボタンの有効化
			} catch(e) {
				document.getElementById("Button4").insertAdjacentHTML('afterend','<p>error → hello.html → 回答ボタン有効化時 → ' + e.message + '</p>'); // エラー時ページに表示
			}
			//            document.getElementById("Button4").insertAdjacentHTML('afterend','<p>countObj.four(for内) = ' + countObj.four + '</p>'); // ページに表示
		}
		countObj.four = x;
		//        document.getElementById("Button4").insertAdjacentHTML('afterend','<p>countObj.four(for外) = ' + countObj.four + '</p>'); // ページに表示      
	}
	
	function setQuestion(data, d){ // 問題文と選択肢を表示
		$("#qNum").html('問題' + d.countObjCount);
		$("#qSentence").html(data[0][0]);
		for (var j=1; j<=4; ++j){
			$("#q" + j).html(data[0][j]);
		}
		//        document.getElementById("Button4").insertAdjacentHTML('afterend', '<p>d.resolveA = ' + d.resolveA + '</p>');
		//        document.getElementById("Button4").insertAdjacentHTML('afterend', '<p>d.QAInfo = ' + d.QAInfo + '</p>');
		//        document.getElementById("Button4").insertAdjacentHTML('afterend', '<p>res = ' + resolveOfCallQAInfo + '</p>');
		
		d.resolveA();
		
	}
	
	function dispCorrectOrMiss(OrMiss){ // 正解･不正解を表示
		if (OrMiss == 1){
			$("#CorrectOrMiss").html('正解');
		} else {
			$("#CorrectOrMiss").html('不正解');
		}
		$("#next").style.opacity = 1; // 次に進むボタンを表示
		if (countObj.qNumBefore !== countObj.count){ // 同じ問題番号で2回以上回答ボタンを押せない
			countObj.qNumBefore = countObj.count;
			try {  // nextボタンを有効化
				//                document.getElementById("next").style.background = '#0000ff';
				document.getElementById("next").addEventListener("click", nextQuestion, {once:true});
			} catch(e){
				document.getElementById("Button4").insertAdjacentHTML("afterend","<p>error → hello.html → イベントハンドラの追加時 → " + e.message + "</p>"); // ページに表示
			}
			//            document.getElementById("Button4").insertAdjacentHTML("afterend","<p>functionality added to 次へ進む</p>"); // ページに表示
		}
	}
	
	function failedAccess(numQ, functionName){ // gs関数の呼び出しに失敗したら
		document.getElementById("Button4").insertAdjacentHTML('afterend','<p>missed to call' + functionName +  numQ + '</p>'); // ページに表示
	}
	
	try {
		let count = 0;
		do {
			// document.getElementById("Button4").insertAdjacentHTML('afterend','<p>1であれば問題なし = ' + closer(0) + '</p>');
			nextQuestion();
		} while (count == 10);
	} catch (k) {
		document.getElementById("Button4").insertAdjacentHTML('afterend','<p>error → hello.html → do while文中→ ' + k.message + '</p>'); // ページに表示
	}
	</script>
</body>
</html>