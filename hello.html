<!DOCTYPE html>
<html>
<head>
<base target="_top">
<script src="https://code.jquery.com/jquery-3.1.1.js"></script>
</head>
<body>
	<p id="qNum">おはよう</p>
	<p id='qSentence'>こんにちは</p> <!-- 問題文を取得 -->
	<ol id="qOL">
		<li id='q1'></li> <!-- 選択肢1を表示 -->
		<li id='q2'></li>
		<li id='q3'></li>
		<li id='q4'></li>
	</ol>

	<p id='CorrectOrMiss'>ここに正解･不正解が表示されます</p> <!-- 正解･不正解を表示 -->
	<input type="button" id="next" value="次に進む">
	
	<script>
    let elementInputOne, elementInputTwo, elementInputThree, elementInputFour;
    
    for (let i=1; i<3; ++i){
        let elementInput = document.createElement("input");
        if (i == 2){
            elementInputTwo = elementInput;
        } else if (i == 1) {
            elementInputOne = elementInput;
        }
        elementInput.setAttribute("id", "Button" + i);
        elementInput.setAttribute("type", "Button");
        elementInput.setAttribute("value", i);
        $("body")[0].insertBefore(elementInput, document.getElementById("CorrectOrMiss"));
    }
    
	let countObj = {
		count: 0,
		qNumBefore: 0,
		countPlus: function() {++this.count;},
        four: 0,
	};
    
    /////////////////////////////////////////// 次の問題文と選択肢の取得及び表示 と 回答ボタンの表示及び有効化 ///////////////////////////////////////////
    
	let nextQuestion = async function (){
        countObj.countPlus(); // 問題番号をインクリメント
		$("#CorrectOrMiss").text('');// 前回の正解･不正解を非表示にする
        if (countObj.count !== 1){ // 一度次に進むボタンが有効化されていたら無効にする
            $("#next")[0].removeEventListener("click",nextQuestion); // 次に進むボタンの無効化
        }
        $("#next").css("opacity", 0.3); // 次に進むボタンの透明度を上げる
		try { // 問題文･選択肢の取得及び表示処理時に
			await callQAInfo(); // 問題文及び選択肢の取得及び表示が終了するまで実行が停止
		} catch (e) {
			$("#Button4").after('<p>error → hello.html → 問題文など取得時 → ' + e.message + '</p>'); // エラー時に画面出力
		}
		
		for (let i = 1; i <= 4; ++i){
			$("#Button" + i).css("opacity", 1); // 回答ボタンの表示
			try { // 回答ボタンの有効化時に発生しうるエラーに対するハンドラの追加
				$("#Button" + i)[0].setAttribute("onclick","checkTheAnswer(" + i + ")"); // 回答ボタンの有効化
			} catch(e) { // もしエラーが発生した場合は
				$("#Button4").after('<p>error → hello.html → 回答ボタン有効化時 → ' + e.message + '</p>'); // エラー時に画面出力
			}
		}
	}
    
	/////////////////////////////////////////// 回答ボタンがクリックされたときに, 正解・不正解を表示 ///////////////////////////////////////////
    
	let checkTheAnswer = async function (clickedNum){
		for (let i = 1; i <= 4; ++i){  // 回答ボタンの無効化
            if ((document.getElementById("Button3") !== null) || i < 3){
			    $("#Button" + i).css("opacity", 0.3); // 回答ボタンの透明度を高める
			    $("#Button" + i)[0].setAttribute("onclick", ""); // 回答ボタンの無効化
            }
		}
		await google.script.run.withSuccessHandler(dispCorrectOrMiss).withFailureHandler(failedAccess).withUserObject({qNum: countObj.count, calledFunctionInGS: 'answerButtonClick'}).answerButtonClick(clickedNum, countObj.count);
        try {  // nextボタンを有効化
            $("#next")[0].addEventListener("click", nextQuestion, {once: true});
        } catch(e) {
            $("#Button4").after("<p>error → hello.html → イベントハンドラの追加時 → " + e.message + "</p>"); // ページに表示
        }        
	}
	
    /////////////////////////////////////////// 次の問題文･選択肢を取得及び表示 ///////////////////////////////////////////
    
	let callQAInfo = function (){
		return new Promise((resolve, reject) => { // Promiseのインスタンスを返す
			google.script.run.withSuccessHandler(setQuestion).withFailureHandler(failedAccess).withUserObject({qNum: countObj.count, calledFunctionInGS: "QAInfo", resolveA: resolve, rejectA: reject}).QAInfo(countObj.count); // countObj.count番目の問題を出題
		});
	}    
    
    /////////////////////////////////////////// 問題文と選択肢を表示 ///////////////////////////////////////////
    
	let setQuestion = function (data, d){
        if (document.getElementById("Button3") !== null){
            document.body.removeChild(document.getElementById("Button3"));
            document.body.removeChild(document.getElementById("Button4"));
        }
		$("#qNum").text('問題' + d.qNum); // 問題番号を表示
		$("#qSentence").text(data[0][0]); // 問題文を表示
        if (data[0][3] !== ''){ // 選択肢が3つ以上あれば要素を追加
            for (let i=3; i<5; ++i){ 
                let elementInput = document.createElement("input");
                if (i == 4){
                    elementInputFour = elementInput;
                } else if (i == 3) {
                    elementInputThree = elementInput;
                }
                elementInput.setAttribute("id", "Button" + i);
                elementInput.setAttribute("type", "Button");
                elementInput.setAttribute("value", i);
                $("body")[0].insertBefore(elementInput, document.getElementById("CorrectOrMiss"));
            }
        }      
        for (let i=1; i<=4; ++i){
		    $("#q" + i).text(data[0][i]); // 選択肢を表示
        }

		d.resolveA(); // 問題文と選択肢を表示が終了したらPromiseオブジェクトの値をfulfilledにする
	}
	
    /////////////////////////////////////////// 正解･不正解を表示 ///////////////////////////////////////////
    
	let dispCorrectOrMiss = function (OrMiss){
		if (OrMiss == 1){
			$("#CorrectOrMiss").text('正解');
		} else {
			$("#CorrectOrMiss").text('不正解');
		}
		$("#next").css("opacity", 1); // 次に進むボタンを表示
	}
	
    /////////////////////////////////////////// gs関数の呼び出しに失敗したら ///////////////////////////////////////////
    
	let failedAccess = function (err, obj){
		$("#Button4").after('<p>missed to call ' + obj.calledFunctionInGS + ' error : ' + err + '</p>'); // ページに表示
	}
	
	nextQuestion();
	</script>
</body>
</html>